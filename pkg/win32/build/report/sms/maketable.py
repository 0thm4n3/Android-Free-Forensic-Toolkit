#!/usr/bin/env python

import apsw, getopt, os, io, sys, shutil, re, time, report.makehtml


def makereport(case):
	csslocation = os.path.join(case, "reports", "mms-sms", "report.css")
	reportfilelocation = os.path.join(case, "reports", "mms-sms", "report.html")
	reportfile = open(reportfilelocation, 'w')
	reportname = "SMS Messages"
	css = open(csslocation, 'w')
	makecss(css)
	css.close()
	report.makehtml.makehead(reportfile, reportname)
	report.makehtml.importnavbar(reportfile, case)
	report.makehtml.makemid(reportfile)
	maketable(reportfile, case)
	reportfile.close()
	

def maketable(reportfile, case):
	reportfiledb = os.path.join(case, "extracted data", "mms-sms", "db", "mmssms.db")
	reportfile_connection=apsw.Connection(reportfiledb)
	reportfile_cursor1=reportfile_connection.cursor()
	reportfile_cursor2=reportfile_connection.cursor()
	reportfile_cursor3=reportfile_connection.cursor()

	contactfiledb = os.path.join(case, "extracted data", "contacts", "db", "contacts2.db")
	contactfile_connection=apsw.Connection(contactfiledb)
	contactfile_cursor1=contactfile_connection.cursor()
	contactfile_cursor2=contactfile_connection.cursor()

	phone1 = re.compile("0")
	phone2 = re.compile("\+")

	reportfile.write("<table CELLPADDING=8 CELLSPACING=0 VALIGN=TOP>\n")
	reportfile.write("</table>\n")
	reportfile.write("<div class=\"ResultsTable\">\n")
	reportfile.write("<table>\n")
	reportfile.write("<tr class=\"title\"><td><b>Status</b></td><td><b>Name</b></td><td><b>Number</b></td><td><b>Content</b></td><td><b>Date/Time Recieved</b></td><td><b>Date/Time Sent</b></td></tr>\n")
	for row1 in reportfile_cursor1.execute("SELECT _id FROM sms ORDER BY date DESC"):
		for entry in row1:						
			for row2 in reportfile_cursor2.execute("SELECT type FROM sms where _id = " + str(entry)):
				for status in row2:
					if str(status) == '1':				
						typename = 'Recieved'
						reportfile.write("<TR class=\"Recieved\">")
					elif str(status) == '2':
						typename = 'Sent'
						reportfile.write("<TR class=\"Sent\">")
					elif str(status) == '3':
						typename = 'Draft'
						reportfile.write("<TR class=\"Draft\">")
					elif str(status) == '5':
						typename = 'Error'
						reportfile.write("<TR class=\"Error\">")
					else:
						typename = 'Unknown (' + str(status) + ')'
						reportfile.write("<TR>")
					reportfile.write("<TD>" + typename + "</TD>")
			for row2 in reportfile_cursor2.execute("SELECT address FROM sms where _id = " + str(entry)):
				for number in row2:
					namestr = 'Unknown'
					address = str(number)
					address = address.replace(" ","")
					if phone1.match(address) or phone2.match(address):
						for row3 in contactfile_cursor1.execute("SELECT raw_contact_id FROM phone_lookup where normalized_number = '" + address + "'"):
							for contactid in row3:
								if str(contactid) == 'None':
									namestr = 'None'
								else:
									for row4 in contactfile_cursor2.execute("SELECT display_name FROM raw_contacts where _id = '" + str(contactid) + "'"):
										for name in row4:
											namestr = str(name)
					reportfile.write("<TD>" + namestr + "</TD>")
			for row2 in reportfile_cursor2.execute("SELECT address FROM sms where _id = " + str(entry)):				
				for number in row2:
					reportfile.write("<TD>" + str(number) + "</TD>")
			for row2 in reportfile_cursor2.execute("SELECT body FROM sms where _id = " + str(entry)):				
				for body in row2:
					reportfile.write("<TD>" + str(body) + "</TD>")
			for row2 in reportfile_cursor2.execute("SELECT datetime(date/1000,'unixepoch','localtime') as date FROM sms where _id = " + str(entry)):				
				for date in row2:
					reportfile.write("<TD>" + str(date) + "</TD>")
			for row2 in reportfile_cursor2.execute("SELECT datetime(date/1000,'unixepoch','localtime') as date_sent FROM sms where _id = " + str(entry)):				
				for sent in row2:
					reportfile.write("<TD>" + str(sent) + "</TD>")
			
			reportfile.write("</TR>")



def makecss(css):
	css.write(".ResultsTable {\n")
	css.write("margin:0px;padding:0px;\n")
	css.write("width:100%;\n")
	css.write("box-shadow: 10px 10px 5px #888888;\n")
	css.write("border:1px solid #000000;\n")
	css.write("\n")
	css.write("-moz-border-radius-bottomleft:5px;\n")
	css.write("-webkit-border-bottom-left-radius:5px;\n")
	css.write("border-bottom-left-radius:5px;\n")
	css.write("\n")
	css.write("-moz-border-radius-bottomright:5px;\n")
	css.write("-webkit-border-bottom-right-radius:5px;\n")
	css.write("border-bottom-right-radius:5px;\n")
	css.write("\n")
	css.write("-moz-border-radius-topright:5px;\n")
	css.write("-webkit-border-top-right-radius:5px;\n")
	css.write("border-top-right-radius:5px;\n")
	css.write("\n")
	css.write("-moz-border-radius-topleft:5px;\n")
	css.write("-webkit-border-top-left-radius:5px;\n")
	css.write("border-top-left-radius:5px;\n")
	css.write("}.ResultsTable table{\n")
	css.write("border-collapse: collapse;\n")
	css.write("border-spacing: 0;\n")
	css.write("width:100%;\n")
	css.write("height:100%;\n")
	css.write("margin:0px;padding:0px;\n")
	css.write("}.ResultsTable tr:last-child td:last-child {\n")
	css.write("-moz-border-radius-bottomright:5px;\n")
	css.write("-webkit-border-bottom-right-radius:5px;\n")
	css.write("border-bottom-right-radius:5px;\n")
	css.write("}\n")
	css.write(".ResultsTable table tr:first-child td:first-child {\n")
	css.write("-moz-border-radius-topleft:5px;\n")
	css.write("-webkit-border-top-left-radius:5px;\n")
	css.write("border-top-left-radius:5px;\n")
	css.write("}\n")
	css.write(".ResultsTable table tr:first-child td:last-child {\n")
	css.write("-moz-border-radius-topright:5px;\n")
	css.write("-webkit-border-top-right-radius:5px;\n")
	css.write("border-top-right-radius:5px;\n")
	css.write("}.ResultsTable tr:last-child td:first-child{\n")
	css.write("-moz-border-radius-bottomleft:5px;\n")
	css.write("-webkit-border-bottom-left-radius:5px;\n")
	css.write("border-bottom-left-radius:5px;\n")
	css.write("}.ResultsTable tr:hover td{\n")
	css.write("\n")
	css.write("}\n")
	css.write(".ResultsTable tr.sent{ background-color:#88FF88; }\n")
	css.write(".ResultsTable tr.recieved { background-color:#8888FF; }\n")
	css.write(".ResultsTable tr.draft { background-color:#FFFF88; }\n")
	css.write(".ResultsTable tr.error { background-color:#FF8888; }.ResultsTable td{\n")
	css.write("vertical-align:middle;\n")
	css.write("\n")
	css.write("\n")
	css.write("border:1px solid #000000;\n")
	css.write("border-width:0px 1px 1px 0px;\n")
	css.write("text-align:left;\n")
	css.write("padding:10px;\n")
	css.write("font-size:12px;\n")
	css.write("font-family:Arial;\n")
	css.write("font-weight:normal;\n")
	css.write("color:#000000;\n")
	css.write("}.ResultsTable tr:last-child td{\n")
	css.write("border-width:0px 1px 0px 0px;\n")
	css.write("}.ResultsTable tr td:last-child{\n")
	css.write("border-width:0px 0px 1px 0px;\n")
	css.write("}.ResultsTable tr:last-child td:last-child{\n")
	css.write("border-width:0px 0px 0px 0px;\n")
	css.write("}\n")
	css.write(".ResultsTable tr.title td{\n")
	css.write("background:-o-linear-gradient(bottom, #005fbf 5%, #003f7f 100%); background:-webkit-gradient( linear, left top, left bottom, color-stop(0.05, #005fbf), color-stop(1, #003f7f) );\n")
	css.write("background:-moz-linear-gradient( center top, #005fbf 5%, #003f7f 100% );\n")
	css.write("filter:progid:DXImageTransform.Microsoft.gradient(startColorstr=\"#005fbf\", endColorstr=\"#003f7f\"); background: -o-linear-gradient(top,#005fbf,003f7f);\n")
	css.write("\n")
	css.write("background-color:#005fbf;\n")
	css.write("border:0px solid #000000;\n")
	css.write("text-align:center;\n")
	css.write("border-width:0px 0px 1px 1px;\n")
	css.write("font-size:14px;\n")
	css.write("font-family:Trebuchet MS;\n")
	css.write("font-weight:bold;\n")
	css.write("color:#ffffff;\n")
	css.write("}\n")
	css.write(".ResultsTable tr:first-child:hover td{\n")
	css.write("background:-o-linear-gradient(bottom, #005fbf 5%, #003f7f 100%); background:-webkit-gradient( linear, left top, left bottom, color-stop(0.05, #005fbf), color-stop(1, #003f7f) );\n")
	css.write("background:-moz-linear-gradient( center top, #005fbf 5%, #003f7f 100% );\n")
	css.write("filter:progid:DXImageTransform.Microsoft.gradient(startColorstr=\"#005fbf\", endColorstr=\"#003f7f\"); background: -o-linear-gradient(top,#005fbf,003f7f);\n")
	css.write("\n")
	css.write("background-color:#005fbf;\n")
	css.write("}\n")
	css.write(".ResultsTable tr:first-child td:first-child{\n")
	css.write("border-width:0px 0px 1px 0px;\n")
	css.write("}\n")
	css.write(".ResultsTable tr:first-child td:last-child{\n")
	css.write("border-width:0px 0px 1px 1px;\n")
	css.write("}\n")
	css.write("\n")
	css.write(".SideBar {\n")
	css.write("margin:0px;padding:0px;\n")
	css.write("width:100%;\n")
	css.write("box-shadow: 10px 10px 5px #888888;\n")
	css.write("border:1px solid #000000;\n")
	css.write("\n")
	css.write("-moz-border-radius-bottomleft:5px;\n")
	css.write("-webkit-border-bottom-left-radius:5px;\n")
	css.write("border-bottom-left-radius:5px;\n")
	css.write("\n")
	css.write("-moz-border-radius-bottomright:5px;\n")
	css.write("-webkit-border-bottom-right-radius:5px;\n")
	css.write("border-bottom-right-radius:5px;\n")
	css.write("\n")
	css.write("-moz-border-radius-topright:5px;\n")
	css.write("-webkit-border-top-right-radius:5px;\n")
	css.write("border-top-right-radius:5px;\n")
	css.write("\n")
	css.write("-moz-border-radius-topleft:5px;\n")
	css.write("-webkit-border-top-left-radius:5px;\n")
	css.write("border-top-left-radius:5px;\n")
	css.write("}.SideBar table{\n")
	css.write("border-collapse: collapse;\n")
	css.write("border-spacing: 0;\n")
	css.write("width:100%;\n")
	css.write("height:100%;\n")
	css.write("margin:0px;padding:0px;\n")
	css.write("}.SideBar tr:last-child td:last-child {\n")
	css.write("-moz-border-radius-bottomright:5px;\n")
	css.write("-webkit-border-bottom-right-radius:5px;\n")
	css.write("border-bottom-right-radius:5px;\n")
	css.write("}\n")
	css.write(".SideBar table tr:first-child td:first-child {\n")
	css.write("-moz-border-radius-topleft:5px;\n")
	css.write("-webkit-border-top-left-radius:5px;\n")
	css.write("border-top-left-radius:5px;\n")
	css.write("}\n")
	css.write(".SideBar table tr:first-child td:last-child {\n")
	css.write("-moz-border-radius-topright:5px;\n")
	css.write("-webkit-border-top-right-radius:5px;\n")
	css.write("border-top-right-radius:5px;\n")
	css.write("}.SideBar tr:last-child td:first-child{\n")
	css.write("-moz-border-radius-bottomleft:5px;\n")
	css.write("-webkit-border-bottom-left-radius:5px;\n")
	css.write("border-bottom-left-radius:5px;\n")
	css.write("}.SideBar tr:hover td{\n")
	css.write("background-color:#ffffff;\n")
	css.write("\n")
	css.write("\n")
	css.write("}\n")
	css.write(".SideBar td{\n")
	css.write("vertical-align:middle;\n")
	css.write("\n")
	css.write("background-color:#c8ffff;\n")
	css.write("\n")
	css.write("border:1px solid #000000;\n")
	css.write("border-width:0px 1px 1px 0px;\n")
	css.write("text-align:left;\n")
	css.write("padding:9px;\n")
	css.write("font-size:12px;\n")
	css.write("font-family:Arial;\n")
	css.write("font-weight:normal;\n")
	css.write("color:#000000;\n")
	css.write("}.SideBar tr:last-child td{\n")
	css.write("border-width:0px 1px 0px 0px;\n")
	css.write("}.SideBar tr td:last-child{\n")
	css.write("border-width:0px 0px 1px 0px;\n")
	css.write("}.SideBar tr:last-child td:last-child{\n")
	css.write("border-width:0px 0px 0px 0px;\n")
	css.write("}\n")
	css.write(".SideBar tr:first-child td{\n")
	css.write("background:-o-linear-gradient(bottom, #5656ff 5%, #2b2b7f 100%); background:-webkit-gradient( linear, left top, left bottom, color-stop(0.05, #5656ff), color-stop(1, #2b2b7f) );\n")
	css.write("background:-moz-linear-gradient( center top, #5656ff 5%, #2b2b7f 100% );\n")
	css.write("filter:progid:DXImageTransform.Microsoft.gradient(startColorstr=\"#5656ff\", endColorstr=\"#2b2b7f\"); background: -o-linear-gradient(top,#5656ff,2b2b7f);\n")
	css.write("\n")
	css.write("background-color:#5656ff;\n")
	css.write("border:0px solid #000000;\n")
	css.write("text-align:center;\n")
	css.write("border-width:0px 0px 1px 1px;\n")
	css.write("font-size:14px;\n")
	css.write("font-family:Arial;\n")
	css.write("font-weight:bold;\n")
	css.write("color:#ffffff;\n")
	css.write("}\n")
	css.write(".SideBar tr:first-child:hover td{\n")
	css.write("background:-o-linear-gradient(bottom, #5656ff 5%, #2b2b7f 100%); background:-webkit-gradient( linear, left top, left bottom, color-stop(0.05, #5656ff), color-stop(1, #2b2b7f) );\n")
	css.write("background:-moz-linear-gradient( center top, #5656ff 5%, #2b2b7f 100% );\n")
	css.write("filter:progid:DXImageTransform.Microsoft.gradient(startColorstr=\"#5656ff\", endColorstr=\"#2b2b7f\"); background: -o-linear-gradient(top,#5656ff,2b2b7f);\n")
	css.write("\n")
	css.write("background-color:#5656ff;\n")
	css.write("}\n")
	css.write(".SideBar tr:first-child td:first-child{\n")
	css.write("border-width:0px 0px 1px 0px;\n")
	css.write("}\n")
	css.write(".SideBar tr:first-child td:last-child{\n")
	css.write("border-width:0px 0px 1px 1px;\n")
	css.write("}\n")
